
import { AppData, DietRecommendation } from "../types";

// ==========================================
// æœ¬åœ°æ™ºèƒ½å¼•æ“é…ç½® (Local Smart Engine)
// å®Œå…¨å…è´¹ï¼Œç¦»çº¿å¯ç”¨ï¼Œå“åº”ç§’å¼€ï¼Œç»æ—  DeepSeek 402 é”™è¯¯
// ==========================================

// 1. åŸºç¡€é£Ÿç‰©çƒ­é‡åº“ (å•ä½: kcal/ä»½)
const FOOD_CALORIES: Record<string, number> = {
  // ä¸»é£Ÿ
  'ç±³é¥­': 220, 'é¥­': 220, 'ç²¥': 120, 'é¦’å¤´': 220, 'åŒ…å­': 200, 
  'é¢æ¡': 300, 'é¢': 300, 'ç²‰': 280, 'åå¸': 100, 'é¢åŒ…': 150, 
  'å…¨éº¦': 120, 'ç‰ç±³': 100, 'çº¢è–¯': 130, 'ç´«è–¯': 130, 'ç‡•éº¦': 150,
  'ç³™ç±³': 110, 'èéº¦': 100, 'è—œéº¦': 120,

  // è›‹ç™½è´¨
  'é¸¡è›‹': 80, 'è›‹': 80, 'è·åŒ…è›‹': 150, 'æ°´ç…®è›‹': 80, 
  'ç‰›å¥¶': 130, 'è±†æµ†': 100, 'é…¸å¥¶': 120, 'è±†å¥¶': 110,
  'é¸¡èƒ¸': 130, 'é¸¡è‚‰': 180, 'é¸¡è…¿': 260, 'é¸¡ç¿…': 220, 'çº¢çƒ§é¸¡ç¿…': 250,
  'ç‰›è‚‰': 200, 'ç‰›æ’': 300, 'çŒªè‚‰': 350, 'æ’éª¨': 300, 'äº”èŠ±è‚‰': 400,
  'é±¼': 120, 'è™¾': 100, 'è±†è…': 80, 'å¢¨é±¼': 90, 'é±¿é±¼': 100,

  // è”¬æœ
  'é’èœ': 40, 'ç™½èœ': 30, 'è èœ': 30, 'è¥¿è“èŠ±': 35, 'ç”Ÿèœ': 20, 'èŠ±èœ': 35,
  'é»„ç“œ': 20, 'ç•ªèŒ„': 30, 'è¥¿çº¢æŸ¿': 30, 'èƒ¡èåœ': 40, 'çº¢èåœ': 40,
  'è¥¿è‘«èŠ¦': 30, 'è±†èŠ½': 30, 'è±Œè±†': 80,
  'è‹¹æœ': 50, 'é¦™è•‰': 90, 'æ¢¨': 50, 'è¥¿ç“œ': 30, 'è‘¡è„': 60, 
  'æ°´æœ': 60, 'æ²™æ‹‰': 150,

  // é¥®æ–™/é›¶é£Ÿ
  'å’–å•¡': 15, 'ç¾å¼': 10, 'æ‹¿é“': 180, 'å¥¶èŒ¶': 450, 'å¯ä¹': 150,
  'è›‹ç³•': 350, 'é¥¼å¹²': 200, 'å·§å…‹åŠ›': 300, 'è–¯ç‰‡': 300,
  'æ±‰å ¡': 550, 'è–¯æ¡': 350, 'æŠ«è¨': 400, 'ç«é”…': 800, 'çƒ§çƒ¤': 600
};

// 2. å‡è‚¥å»ºè®®çŸ¥è¯†åº“ (æŒ‰æ—¶é—´æ®µ)
const TIPS_DB = {
  morning: [
    { icon: "ğŸŒ", title: "å…ƒæ°”æ—©é¤", text: "æ—©å®‰ï¼æ—©é¤è®°å¾—åƒç‚¹è›‹ç™½è´¨ï¼ˆé¸¡è›‹/ç‰›å¥¶ï¼‰ï¼Œå¼€å¯ä¸€æ•´å¤©çš„é«˜ä»£è°¢ï¼" },
    { icon: "ğŸ¥ª", title: "ç¢³æ°´è¦é€‚é‡", text: "æ—©é¤åƒç‚¹ç²—ç²®é¢åŒ…æˆ–ç‰ç±³ï¼Œæ¯”ç™½ç²¥æ›´æŠ—é¥¿å“¦ï¼" },
    { icon: "ğŸ’§", title: "æ—©èµ·ä¸€æ¯æ°´", text: "èµ·åºŠå…ˆå–æ¸©æ°´ï¼Œå”¤é†’è‚ èƒƒï¼ŒåŠ é€Ÿæ’æ¯’ï¼Œçš®è‚¤ä¹Ÿä¼šå˜å¥½ï¼" },
    { icon: "â˜•ï¸", title: "æ¶ˆè‚¿é»‘å’–", text: "æ—©ä¸Šä¸€æ¯é»‘å’–å•¡ï¼Œå»æ°´è‚¿ç¥å™¨ï¼Œè¿˜èƒ½æç¥é†’è„‘ï¼" }
  ],
  noon: [
    { icon: "ğŸ±", title: "åˆé¤å…«åˆ†é¥±", text: "ç»†åš¼æ…¢å’½ï¼Œæ¯å£åš¼20ä¸‹ï¼Œå¤§è„‘æ‰æœ‰æ—¶é—´æ¥æ”¶'åƒé¥±äº†'çš„ä¿¡å·ã€‚" },
    { icon: "ğŸ¥—", title: "è”¬èœå…ˆåƒ", text: "å…ˆåƒè”¬èœå«åº•ï¼Œå†åƒè‚‰å’Œä¸»é£Ÿï¼Œå¯ä»¥å¹³ç¨³è¡€ç³–ï¼Œä¸æ˜“é•¿èƒ–ã€‚" },
    { icon: "ğŸ—", title: "è¡¥å……ä¼˜è´¨è›‹ç™½", text: "åˆé¤æ¥ç‚¹é¸¡èƒ¸è‚‰æˆ–é±¼è™¾ï¼Œä¸‹åˆæ‰ä¸ä¼šé¥¿å¾—æƒ³åƒé›¶é£Ÿã€‚" }
  ],
  afternoon: [
    { icon: "ğŸµ", title: "æ‹’ç»å¥¶èŒ¶", text: "æƒ³å–é¥®æ–™ï¼Ÿè¯•è¯•é»‘å’–å•¡æˆ–æ— ç³–èŒ¶ï¼Œ0çƒ­é‡è¿˜èƒ½æ¶ˆæ°´è‚¿ï¼" },
    { icon: "ğŸ", title: "åŠ é¤é¦–é€‰", text: "é¥¿äº†åƒä¸ªè‹¹æœæˆ–ä¸€å°æŠŠåšæœï¼Œæ¯”åƒé¥¼å¹²å¥åº·å¤šå•¦ã€‚" },
    { icon: "ğŸ¥¤", title: "å¤šå–æ°´", text: "æœ‰æ—¶å€™æ„Ÿè§‰é¥¿å…¶å®æ˜¯æ¸´äº†ï¼Œå…ˆå–æ¯æ°´è¯•è¯•ï¼Ÿ" }
  ],
  evening: [
    { icon: "ğŸ¥£", title: "æ™šé¤æ¸…æ·¡", text: "æ™šé¤å°‘åƒä¸»é£Ÿï¼Œå¤šåƒè”¬èœå’Œé±¼è™¾ï¼Œå‡è½»è‚ èƒƒè´Ÿæ‹…ã€‚" },
    { icon: "ğŸš¶â€â™€ï¸", title: "é¥­åèµ°èµ°", text: "åƒå®Œé¥­åˆ«é©¬ä¸Šèººä¸‹ï¼Œé å¢™ç«™ç«‹15åˆ†é’Ÿæˆ–æ•£æ­¥å¯¹æ¶ˆåŒ–å¾ˆå¥½å“¦ã€‚" },
    { icon: "ğŸ¥¦", title: "æ§ç³–æ—¶åˆ»", text: "æ™šä¸Šå°½é‡é¿å¼€é«˜ç³–æ°´æœå’Œç”œç‚¹ï¼Œè®©èº«ä½“åœ¨ç¡çœ ä¸­æŒç»­ç‡ƒè„‚ã€‚" }
  ],
  late: [
    { icon: "ğŸŒ™", title: "æ—©ç‚¹ç¡å§", text: "ç†¬å¤œå®¹æ˜“æ‰è‚Œè‚‰é•¿è„‚è‚ªï¼Œæ—©ç¡æ˜¯æ€§ä»·æ¯”æœ€é«˜çš„å‡è‚¥æ³•ï¼" },
    { icon: "ğŸš«", title: "å¿ä½å¤œå®µ", text: "ç¡å‰3å°æ—¶ä¸è¿›é£Ÿï¼Œæ˜æ—©ä½“é‡ä¼šç»™ä½ æƒŠå–œçš„ï¼åšæŒä½ï¼" },
    { icon: "ğŸ›Œ", title: "ç¾å®¹è§‰", text: "æ”¾ä¸‹æ‰‹æœºï¼Œåšä¸ªå¥½æ¢¦ã€‚å……è¶³çš„ç¡çœ èƒ½æŠ‘åˆ¶é£Ÿæ¬²æ¿€ç´ å“¦ã€‚" }
  ]
};

// æ¨¡æ‹Ÿå¤„ç†å»¶è¿Ÿï¼Œå¢åŠ ä»ªå¼æ„Ÿ
const sleep = (ms: number) => new Promise(r => setTimeout(r, ms));

/**
 * æ™ºèƒ½ä¼°ç®—çƒ­é‡ (æœ¬åœ°é€»è¾‘)
 * çº¯æœ¬åœ°è®¡ç®—ï¼Œä¸æ¶ˆè€— API é¢åº¦
 */
export const analyzeFoodCalories = async (
  breakfast: string,
  lunch: string,
  dinner: string
): Promise<number | null> => {
  console.log("ğŸ” Local Smart Engine: Analyzing calories..."); // Debug log
  await sleep(600); // ç¨å¾®æ¨¡æ‹Ÿä¸€ä¸‹è®¡ç®—è¿‡ç¨‹

  let total = 0;
  const combinedText = (breakfast + lunch + dinner).toLowerCase();
  
  // å¦‚æœå®Œå…¨æ²¡å¡«ï¼Œè¿”å› null
  if (!combinedText.trim()) return null;

  let matchCount = 0;

  // 1. å…³é”®è¯åŒ¹é…ç®—æ³•
  for (const [key, cal] of Object.entries(FOOD_CALORIES)) {
    if (combinedText.includes(key)) {
      // ç®€å•çš„æ•°é‡æå–é€»è¾‘ (e.g. "2ä¸ªé¸¡è›‹")
      const regex = new RegExp(`(\\d+)[ä¸ªç¢—ä»½ç‰‡å—æ¯åª]*${key}`);
      const match = combinedText.match(regex);
      const multiplier = match ? parseInt(match[1]) : 1;
      
      total += cal * multiplier;
      matchCount++;
      // console.log(`  Found: ${key} x ${multiplier} = ${cal * multiplier}`);
    }
  }

  // 2. æ¨¡ç³Šä¼°ç®—è¡¥å…¨ (å¦‚æœå†™äº†å­—ä½†æ²¡åŒ¹é…åˆ°åº“é‡Œçš„è¯ï¼Œæˆ–è€…ç®—å‡ºæ¥å¤ªä½)
  // ç»™å‡ºä¸€ä¸ªåŸºç¡€ä¿åº•å€¼ï¼šæ—©é¤300ï¼Œåˆé¤400ï¼Œæ™šé¤300
  if (matchCount === 0 || total < 100) {
    if (breakfast.trim()) total += 300;
    if (lunch.trim()) total += 450;
    if (dinner.trim()) total += 350;
    
    // åŠ ä¸€ç‚¹éšæœºæ³¢åŠ¨ï¼Œè®©å®ƒçœ‹èµ·æ¥åƒæ˜¯çœŸçš„ç®—å‡ºæ¥çš„
    total += Math.floor(Math.random() * 50) - 25;
  } 
  else {
    // 3. ä¿®æ­£é€»è¾‘ (å¦‚æœæœ‰åŒ¹é…ï¼ŒåŠ ä¸ŠåŸºç¡€ä»£è°¢è€—æŸ/çƒ¹é¥ªæ²¹ç›åå·®)
    // é€šå¸¸ä½ä¼°ï¼Œæ‰€ä»¥ä¹˜ä»¥ 1.1 ç³»æ•°
    total = Math.round(total * 1.1);
  }

  console.log("âœ… Local Smart Engine: Result =", total);
  return total > 0 ? total : null;
};

/**
 * è·å–æ™ºèƒ½å»ºè®® (æœ¬åœ°é€»è¾‘)
 * æ ¹æ®æ—¶é—´æ®µéšæœºè¿”å›å»ºè®®ï¼Œæ— éœ€è”ç½‘
 */
export const getDietRecommendation = async (
  profile: AppData['profile'],
  logs: AppData['logs']
): Promise<DietRecommendation | null> => {
  console.log("ğŸ’¡ Local Smart Engine: Getting tip...");
  await sleep(300);
  
  const hour = new Date().getHours();
  let pool = TIPS_DB.morning;
  
  if (hour >= 11 && hour < 14) pool = TIPS_DB.noon;
  else if (hour >= 14 && hour < 18) pool = TIPS_DB.afternoon;
  else if (hour >= 18 && hour < 22) pool = TIPS_DB.evening;
  else if (hour >= 22 || hour < 5) pool = TIPS_DB.late;

  // éšæœºæŠ½å–
  const tip = pool[Math.floor(Math.random() * pool.length)];
  
  // æ’å…¥ä¸€äº›ä¸ªæ€§åŒ–ç§°å‘¼
  const personalizedText = tip.text.replace("æ—©å®‰ï¼", `æ—©å®‰ ${profile.name}ï¼`);
  
  return {
    ...tip,
    text: personalizedText,
    date: new Date().toISOString().split('T')[0]
  };
};
